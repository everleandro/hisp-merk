name: Build iOS App

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: macos-latest

    steps:
      # 1. Checkout del código
      - name: Checkout repository
        uses: actions/checkout@v2

      # 2. Configuración de las variables necesarias para la exportación
      - name: Set up environment variables
        run: |
          echo "export APPLE_TEAM_ID=${{ secrets.APPLE_TEAM_ID }}" >> $GITHUB_ENV
          echo "export APPLE_BUNDLE_ID=${{ secrets.APPLE_BUNDLE_ID }}" >> $GITHUB_ENV
          echo "export PROVISIONING_PROFILE_NAME=${{ secrets.PROVISIONING_PROFILE_NAME }}" >> $GITHUB_ENV

      # 3. Instalar dependencias de CocoaPods (si usas CocoaPods)
      - name: Install dependencies
        run: |
          pod install --repo-update

      # 4. Establecer "Skip Install" para bibliotecas estáticas
      - name: Set Skip Install for static libraries
        run: |
          # Modificar el archivo .xcodeproj o .xcworkspace para establecer Skip Install
          # en las bibliotecas estáticas y frameworks que no deben ser incluidos
          find . -name "*.xcodeproj" -exec sed -i '' 's/SkipInstall = NO;/SkipInstall = YES;/g' {} \;
        
      # 5. Archivar la aplicación
      - name: Archive the app
        run: |
          xcodebuild clean archive \
            -workspace ios/YourApp.xcworkspace \
            -scheme YourScheme \
            -configuration Release \
            -archivePath ${{ github.workspace }}/build/YourApp.xcarchive

      # 6. Crear el archivo exportOptions.plist
      - name: Crear exportOptions.plist
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_BUNDLE_ID: ${{ secrets.APPLE_BUNDLE_ID }}
          PROVISIONING_PROFILE_NAME: ${{ secrets.PROVISIONING_PROFILE_NAME }}
        run: |
          cat <<EOF > ios/App/exportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>ad-hoc</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>teamID</key>
              <string>${APPLE_TEAM_ID}</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>${APPLE_BUNDLE_ID}</key>
                  <string>${PROVISIONING_PROFILE_NAME}</string>
              </dict>
              <key>compileBitcode</key>
              <false/>
              <key>stripSwiftSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF

      # 7. Exportar el archivo IPA
      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath ${{ github.workspace }}/build/YourApp.xcarchive \
            -exportPath ${{ github.workspace }}/build/YourApp \
            -exportOptionsPlist ios/App/exportOptions.plist
